<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>


<div style="text-align: center; margin: 20px 0; font-family: serif; font-style: italic; font-size: 1.5em; color: var(--primary);">
    "The Journey is the Reward"
    <div style="font-size: 0.6em; font-style: normal; margin-top: 5px; opacity: 0.8;">— Steve Jobs</div>
</div>

<div id="life-map" style="height: 600px; width: 100vw; position: relative; left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw; z-index: 1;"></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var map = L.map('life-map').setView([39.9042, 116.4074], 4); // Default view (e.g., Beijing)

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        fetch('/data/life_points.json')
            .then(response => response.json())
            .then(points => {
                
                var markers = L.markerClusterGroup();

                // 遍历数据撒点
                points.forEach(function(point) {
                    var marker = L.marker([point.lat, point.lng]);
                    
                    // 优化了一下弹窗样式，限制图片最大高度，防止撑爆屏幕
                    var popupContent = `
                        <div style="text-align: center; min-width: 300px;">
                            <b style="font-size: 1.2em; display:block; margin-bottom:8px;">${point.title}</b>
                            <div style="width: 100%; max-height: 500px; overflow: hidden; border-radius: 8px;">
                                <img src="${point.img}" style="width: 100%; height: auto; object-fit: cover;" loading="lazy">
                            </div>
                        </div>
                    `;
                    
                    // 修正 Popup 宽度配置
                    marker.bindPopup(popupContent, { 
                        maxWidth: 500,
                        minWidth: 300
                    });

                    marker.on('mouseover', function (e) {
                        this.openPopup();
                    });

                    markers.addLayer(marker);
                });

                map.addLayer(markers);

                // (可选) 自动调整地图视野，包含所有点
                if(points.length > 0){
                    map.fitBounds(markers.getBounds().pad(0.1));
                }
            })
            .catch(error => console.error('Error loading map data:', error));
    });
</script>
